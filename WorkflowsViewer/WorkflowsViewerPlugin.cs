using System;
using System.ComponentModel.Composition;
using System.IO;
using System.Linq;
using System.Collections.Generic;
using System.Reflection;
using XrmToolBox.Extensibility;
using XrmToolBox.Extensibility.Interfaces;

namespace WorkflowsViewer
{
    // Do not forget to update version number and author (company attribute) in AssemblyInfo.cs class
    // To generate Base64 string for Images below, you can use https://www.base64-image.de/
    [Export(typeof(IXrmToolBoxPlugin)),
        ExportMetadata("Name", "Workflows Viewer"),
        ExportMetadata("Author", "BioProfe"),
        ExportMetadata("Description", "Workflows Viewer is used to see the workflows dependencies visually. That is, when you select a workflow, you will see what other workflows execute the one you have selected, and which workflows are executed by the one you have selected"),
        // Please specify the base64 content of a 32x32 pixels image
        ExportMetadata("SmallImageBase64", "iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo0RjY2QkZFNjFGMjA2ODExODA4M0E0NUJCN0ZDNTY4OSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpCMUJCMjY3RUU4QUYxMUUzQThDQUEwOTM5MDlENDEzOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpCMUJCMjY3REU4QUYxMUUzQThDQUEwOTM5MDlENDEzOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NEY2NkJGRTYxRjIwNjgxMTgwODNBNDVCQjdGQzU2ODkiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NEY2NkJGRTYxRjIwNjgxMTgwODNBNDVCQjdGQzU2ODkiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5zOgR2AAAGYElEQVR42qxXC0yTVxT+/lIUyqM8Ci3FqUEQAQXjazrIfE4RzaJx0WyZLnEbOnHZEpyLm8YsPrPNZSo4golb0DkwWzSMxcfAx+aUqdPolKfKLPQFFNpSQED679y/f0vFohS96cltT88959zzvhzP82DrYkkBvFm3b/2TSNse8Wf2+OTJFd6cT1u8Stil8HKR4BDathOs4TgJnefA873zCJ9PuM2kSKs3/KReCGa0mQRfECgCg+SIUo8AL+HQpNdJLeaWdYRfTnRbac8nRR4Nhq9kkMLTabtJkDvcz18xOiYWUrkcO0//jHWFeTChFzGx4+DnL1MwGkYrnnnm4p4WA25+TveR+kKpjIJPgD8Kr/yBI7evAL29LtrZo+ORmbYAATwHo1GPRz3dDH1qoPhwxoBHBUQ/72AmZ34OV0QgPEKJk3euIefqeXR2dw5gTx+8nTQVK6bMRJfFAlNzI+z2XuYKFh9bSJGWpyrQ38/B8lCo1NGo0Dcg99IpVLUYWcwRcJ4VEHkNGybDxpfnYtbYCWg06EHxwdDNBK74eEKBvJ0fpYvmTiQ/Iyp6BMxdXTh46TTOamr6BHNi6HB8P+HsDzvtoiL0SQiNxLrUhRgboYJB24CODhujZO7IXvvZ3lP9s+Ckj48USpUawwIDcbT8LA5XXCVGdjfhomABuCdvz4sK8g6oNDfiw+IfMHsUxUfqAjBXGvTaxJ6e7pMQr/JYGgYFBaONBK4v2Avzw3bAh2gozcaGqZE5+w1MTZqIGs09lN28jDjVSCydmYFDvxUip7wYcaEqbFz0jsCn7MYlFN4655BBOp97UE1Qg+2vLcO4UAWaGg0Dp6HJZu0Tzjl4fLN6E0ZERiGv+AiiFSqse32lcNnxlHppydOIC481s5ZhYeo8vDppBgq27EVJ9n7HeYnjEsxCmpamZ9cBnnMaxxlsEtjabQgOCMR1bS0aTAYowyNw7HoZOh52IG5kjOCaOZNTMXvzKsRvWILS8guYP30mYsOiRT5uPAddiJyHyN9tnTa8MnEqynYWYEp8Cvb98j1qLHrI/GQwNBsxZ1SSoHit2SDQ7zl+SGCRnjCtL34knEclPCsgEHNitAOBskDcb9Cg8MwJ2DrbkTImAXEhaoFUazIiMWpMn9J0pqz+X9TpNG5WHGopFlPNSbSh+ACKzpdgcnwyJkfHCbhgUi45JqGPXrRagH8AqnR1j1mUG1IvoBtYyAUBMpnAIWPaLJy9fhGNNkfTq2/SwdJuhTIsAnNGjhdwhe/twK3q29BYm19MN6w3aHHhxmUUvrtNMPknv+YJ+DpdPa7dv4OiO39CHhCM77K2C3hGu/VYLmrMuhegAKXPttICsQhxfalFa/GuD/CSXCF8zyz8EvjJ7kgjVrzs3AuYB4TKxuOrJVmQBwYj8+hu5L+1ySGw6Gskh0dCIpEITSh/eTZu3qtEadUVZGeswq27lfi94m9Ut4pWcFRnLxRgpZVz3giw2myu75pGLRZEj6HmpEdVhxUr4ya6jtndWFQzF/D8ELLAzrvqORP6wNCADcf3C79v3qvAyEg1jNRYksLVmBc5CnqbRfgvt/wEalv1rgvEslR1Nie7ZxNIPWYe/7gVci6dEHPIjtzLxQDVfkaobbdAJh2GB1YTSn/c7eqImYd3iQJ5l/nBDzIGQqjkyob7oaP7oVjDnRycbU40Mi9Bk83mVjYfb8Wu3S7engJYHRL+dBdYrRYEEW3Ryo+xcsJ0R+Q7Gdj7MWSR7g7uNO5KEI6146NvrkeKQo0WU/OAFlhI49Meo0GX6GsyYUXKDGRQpzv4lziQMI52pyG8G0hiwxTQa7WwdHW6BpInLEBjEptQUgiyenq6Wus1deg2teDTuUuxb9EqjGb57n57d8u440g4G8k2kOBvl6xGSC+P/+7fRVdXp5l4r2cyRFlPHUoV4lzI5kOpPCQMClUUzlTeQO5ghtJJaegwm9HaYiJ97M6hdCsJbh7UVOxpLJcQ84hIJXxpaiq6esHjWP5+6nz4043ZxNMrDMNDHMsHeJgIA6uv73CootRos/ci50IJjG0WrE1LR4JCCYNOh26WPaKf3U39XAr0e5ptIwiTURtW0eTMgs1Izard1sbImJ8/H8zTzOvHqcjwAClyjMUHjdiZ92urnOc9+vmFPk7dFGECskiR3Od5njvX/wIMAFLXCt0HLDMDAAAAAElFTkSuQmCC"),
        // Please specify the base64 content of a 80x80 pixels image
        ExportMetadata("BigImageBase64", "iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAAZdEVYdFNvZnR3YXJlAEFkb2JlIEltYWdlUmVhZHlxyWU8AAADaGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4zLWMwMTEgNjYuMTQ1NjYxLCAyMDEyLzAyLzA2LTE0OjU2OjI3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjRGNjZCRkU2MUYyMDY4MTE4MDgzQTQ1QkI3RkM1Njg5IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkIxQkQ4ODQzRThBRjExRTNBOENBQTA5MzkwOUQ0MTM5IiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkIxQkQ4ODQyRThBRjExRTNBOENBQTA5MzkwOUQ0MTM5IiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzYgKE1hY2ludG9zaCkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo0RjY2QkZFNjFGMjA2ODExODA4M0E0NUJCN0ZDNTY4OSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRp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"),
        ExportMetadata("BackgroundColor", "Lavender"),
        ExportMetadata("PrimaryFontColor", "Black"),
        ExportMetadata("SecondaryFontColor", "Gray")]
    public class WorkflowsViewerPlugin : PluginBase
    {
        public override IXrmToolBoxPluginControl GetControl()
        {
            return new WorkflowsViewerControl();
        }

        /// <summary>
        /// Constructor 
        /// </summary>
        public WorkflowsViewerPlugin()
        {
            // If you have external assemblies that you need to load, uncomment the following to 
            // hook into the event that will fire when an Assembly fails to resolve
            // AppDomain.CurrentDomain.AssemblyResolve += new ResolveEventHandler(AssemblyResolveEventHandler);
        }

        /// <summary>
        /// Event fired by CLR when an assembly reference fails to load
        /// Assumes that related assemblies will be loaded from a subfolder named the same as the Plugin
        /// For example, a folder named Sample.XrmToolBox.MyPlugin 
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="args"></param>
        /// <returns></returns>
        private Assembly AssemblyResolveEventHandler(object sender, ResolveEventArgs args)
        {
            Assembly loadAssembly = null;
            Assembly currAssembly = Assembly.GetExecutingAssembly();

            // base name of the assembly that failed to resolve
            var argName = args.Name.Substring(0, args.Name.IndexOf(","));

            // check to see if the failing assembly is one that we reference.
            List<AssemblyName> refAssemblies = currAssembly.GetReferencedAssemblies().ToList();
            var refAssembly = refAssemblies.Where(a => a.Name == argName).FirstOrDefault();

            // if the current unresolved assembly is referenced by our plugin, attempt to load
            if (refAssembly != null)
            {
                // load from the path to this plugin assembly, not host executable
                string dir = Path.GetDirectoryName(currAssembly.Location).ToLower();
                string folder = Path.GetFileNameWithoutExtension(currAssembly.Location);
                dir = Path.Combine(dir, folder);

                var assmbPath = Path.Combine(dir, $"{argName}.dll");

                if (File.Exists(assmbPath))
                {
                    loadAssembly = Assembly.LoadFrom(assmbPath);
                }
                else
                {
                    throw new FileNotFoundException($"Unable to locate dependency: {assmbPath}");
                }
            }

            return loadAssembly;
        }
    }
}